// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Example User model
model User {
    id Int @id @default(autoincrement())

    // personal details
    email    String  @unique
    name     String?
    phone    String  @unique
    password String
    gender   Gender?
    dob      String?

    // company details
    employmentType   EmploymentType?
    companyName      String?
    netMonthlyIncome Float?
    nextIncomeDate   String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    isVerified     Boolean   @default(false)
    isBlocked      Boolean   @default(false)
    kycExpireAt DateTime?
    kycStatus      kycStatus @default(pending)

    addresses   Address[]
    bankDetails BankDetails[]

    documents    Document[]
    loans        loan[]
    transactions transaction[]

    contactslist contactslist?
    location     location?

    events event[]

    agentUsers AgentUser[]
    followUps followUp[]

    @@map("users")
}

model Address {
    id     Int @id @default(autoincrement())
    userId Int

    street  String
    pinCode String
    city    String
    state   String

    addressType AddressType

    user User @relation(fields: [userId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("addresses")
}

model BankDetails {
    id     Int @id @default(autoincrement())
    userId Int

    bankName          String
    accountNumber     String
    ifscCode          String
    accountHolderName String

    user User @relation(fields: [userId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    isdeleted Boolean @default(false)

    loans loan[]

    @@map("bank_details")
}

model Document {
    id     Int @id @default(autoincrement())
    userId Int

    documentType DocumentType
    documentUrl  String

    user User @relation(fields: [userId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("documents")
}

model loan {
    id         Int    @id @default(autoincrement())
    userId     Int
    bankId     Int
    loanNumber String @unique @default(dbgenerated("('MP' || LPAD(FLOOR(random() * 10000000000)::text, 10, '0'))"))

    requestedAmount Float
    requestedTenure Int // in days

    principalAmount Float?
    tenure          Int? // in days

    // intrest 
    intrestType  IntrestType?
    intrestRate  Float?
    totalIntrest Float?

    totalAmountPayable Float?

    // penelty
    penaltyAmount Float? @default(0)

    status loanStatus @default(requested)

    // date 
    startDate DateTime?
    endDate   DateTime?

    paidAmount      Float? @default(0)
    remainingAmount Float?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user User        @relation(fields: [userId], references: [id])
    bank BankDetails @relation(fields: [bankId], references: [id])

    transactions transaction[]
    followUps    followUp[]

    @@map("loans")
}

model transaction {
    id     Int @id @default(autoincrement())
    loanId Int
    userId Int

    amount          Float
    transactionType transactionType

    rpzOrderId         String? @unique
    rpzRefundPaymentId String? @unique
    rpzPaymentId       String? @unique

    user User @relation(fields: [userId], references: [id])
    loan loan @relation(fields: [loanId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("transactions")
}

model contactslist {
    id     Int @id @default(autoincrement())
    userId Int @unique

    contactList Json

    user User @relation(fields: [userId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("contacts")
}

model location {
    id     Int @id @default(autoincrement())
    userId Int @unique

    latitude  Float
    longitude Float

    user User @relation(fields: [userId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("locations")
}

model event {
    id     Int @id @default(autoincrement())
    userId Int

    eventType eventType
    title     String
    message   String

    isRead Boolean @default(false)
    route  String?
    params Json?

    user User @relation(fields: [userId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("events")
}

model Admin {
    id       Int    @id @default(autoincrement())
    name     String
    phone    String @unique
    email    String @unique
    password String

    role AdminRole

    isDeleted Boolean @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    agents AgentUser[]
    followUps followUp[]

    @@map("admins")

}


model AgentUser{
    id       Int    @id @default(autoincrement())

    agentId  Int
    userId   Int

    agent Admin @relation(fields: [agentId], references: [id])
    user  User  @relation(fields: [userId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("agent_users")
}

model followUp{
    id       Int    @id @default(autoincrement())


    agentUserId  Int
    userId   Int
    loanId   Int

    note     String
    followUpDate DateTime
    nextFollowUpDate DateTime?
    followUpType followUpType

    agentUser Admin @relation(fields: [agentUserId], references: [id])
    user  User  @relation(fields: [userId], references: [id])
    loan  loan  @relation(fields: [loanId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("follow_ups")
}

// ======================= Enums ================================= //
enum Gender {
    male
    female
    other
}

enum EmploymentType {
    self
    employed
}

enum AddressType {
    residential
    employment
}

enum DocumentType {
    aadhar
    pan
    selfie
    bankStatement
    cibilScore
    residentialAddressProof
    employmentAddressProof
}

enum kycStatus {
    pending
    submitted
    verified
    rejected
    resubmit
}

enum IntrestType {
    flat
    daily
}

enum loanStatus {
    requested
    applied
    approved
    active
    closed
    overdue
    defaulted
}

enum transactionType {
    disbursement
    repayment
}

enum eventType {
    notification
    activity
}

enum AdminRole {
    admin
    agent
}


enum followUpType {
    call
    sms
    email
    fieldVisit
}